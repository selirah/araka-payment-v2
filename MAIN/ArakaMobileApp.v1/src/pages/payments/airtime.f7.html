<template>
    <div class="page no-toolbar" data-name="airtime">
        <!-- <div class="preloader color-multi"></div> -->

        <div class="page-content airtimePage display-flex flex-direction-column">

            <div class="justify-content-start margin-top">
                <a class="link padding-left padding-right"
                    data-transition="f7-push" href="/home/">
                    <i class="icon icon-back text-color-brown"></i>
                </a>
            </div>

            <div class="justify-content-center mb-auto text-align-center padding">
                <div class="block no-margin-bottom text-align-center">
                    <img src={{logo}} alt="ARAKA" class="img-fluid-header">
                    <div class="intro-text">
                        <p class="intro-subheader">
                            Hey, <em>{{userData.name}}</em>! Which telco provider would you like to top-up on?
                        </p>
                        <p class="notice">SELECT ONLY ONE PROVIDER</p>
                    </div>
                </div>
                <div class="row">
                    {{#categories}}
                    <div class="col-33 provider-images" data-name='{{productId}}'>
                        <img src="data:image/png;base64, {{image}}" alt='{{name}}' @click="selectProvider">
                    </div>
                    {{/categories}}
                </div>
            </div>
        </div>

        <!-- pay popup -->
        <div class="popup airtime-popup">
            <div class="justify-content-start margin-top">
                <a class="link popup-close padding-left padding-right" href="#">
                    <i class="icon f7-icons text-color-brown">xmark</i>
                </a>
            </div>
            <div class="airtime-2 display-flex flex-direction-column overflow-y-auto">
                <div class="justify-content-start">
                    <div class="block no-margin-bottom text-align-center">
                        <img src={{logo}} alt="ARAKA" class="img-fluid-header">
                    </div>
                    <div class="text-align-center transactionDate">
                        <p class="font-weight-bold">{{currDate}}</p>
                    </div>
                    <div class="block">
                        <h5 class="no-margin-vertical transactionWizardHeader">Payments for</h5>
                        <button class="w-40 transactionWizardButton button"><i class="icon f7-icons">phone_fill</i> airtime top-up</button>
                    </div>
                    <div class="block no-margin-top">
                        <h5 class="no-margin-vertical transactionWizardHeader">Provider</h5>
                        <img src="" alt="" class="provider-img">
                    </div>
                    <div class="block no-margin-top">
                        <div id="formio"></div>
                    </div>
                </div>
                <div class="justify-content-end mt-auto mb-30 text-align-center">
                    <a href="" id="proceedSummary" class="w-40 mx-auto button button-raised button-large button-fill elevation-12 elevation-pressed-20 elevation-transition disabled" @click="makePayment">
                        Continue
                    </a>
                </div>
            </div>
        </div>

        <!-- summary popup -->
        <div class="popup airtime-summary">
            <div class="justify-content-start margin-top">
                <a class="link popup-close padding-left padding-right" href="#">
                    <i class="icon icon-back text-color-brown"></i>
                </a>
            </div>

            <div class="airtime-1 display-flex flex-direction-column padding overflow-y-auto">
                <div class="justify-content-start">
                    <div class="block no-margin-bottom text-align-center">
                        <img src={{logo}} alt="ARAKA" class="img-fluid-header">
                    </div>
                    <div class="text-align-center transactionDate">
                        <p class="font-weight-bold">{{currDate}}</p>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h5 class="no-margin-vertical transactionWizardHeader">Payments for</h5>
                            <button class="w-40 transactionWizardButton button"><i class="icon f7-icons">phone_fill</i> airtime top-up</button>
                        </div>
                    </div>
                    <div class="row margin-top">
                        <div class="col">
                            <h5 class="no-margin-vertical transactionWizardHeader">Provider</h5>
                            <img src="" alt="" class="provider-img">
                        </div>
                    </div>
                    <div class="row margin-top">
                        <div class="col-50">
                            <h5 class="no-margin-vertical transactionWizardHeader">Receipient</h5>
                            <button class="w-40 transactionWizardButton receipient button"></button>
                        </div>
                        <div class="col-50">
                            <h5 class="no-margin-vertical transactionWizardHeader">Amount</h5>
                            <button class="w-40 transactionWizardButton amt button"><i class="icon f7-icons">money_dollar_circle_fill</i> <span></span></button>
                        </div>
                    </div>
                    <div class="row margin-top">
                        <div class="col-50">
                            <h5 class="no-margin-vertical transactionWizardHeader">Fee</h5>
                            <button class="w-40 transactionWizardButton fee button"><i class="icon f7-icons">money_dollar_circle_fill</i> <span></span></button>
                        </div>
                        <div class="col-50">
                            <h5 class="no-margin-vertical transactionWizardHeader">VAT</h5>
                            <button class="w-40 transactionWizardButton vat button"><i class="icon f7-icons">money_dollar_circle_fill</i> <span></span></button>
                        </div>
                    </div>
                </div>
                <div class="justify-content-end mt-auto mb-30 text-align-center">
                    <a href="" id="proceedSummary" class="w-40 mx-auto button button-raised button-large button-fill elevation-12 elevation-pressed-20 elevation-transition" @click="performTransaction">
                       Make Payment
                    </a>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    import logo from '../../images/welcome_araka-alt.png';
    import app from '../../js/app.js';
    import $$ from 'dom7';
    import axios from 'axios';
    import dayjs from 'dayjs';
    import { Formio } from 'formiojs';


    // let productCategories = localStorage.getItem('productCategories') ? JSON.parse(localStorage.getItem('productCategories')) : null;
    // console.log(productCategories);
    // let airtimeSettings = productCategories ? productCategories.filter(product => product.name === 'Airtime') : [];
    // let airtimeProducts = airtimeSettings.length > 0 ? airtimeSettings[0].products : null;
    let currentDate = dayjs().format('DD. MMMM, h:mm a');
    // let formio = new Formio();
    // console.log(formio);
    // let productId = localStorage.getItem('selectedProduct') ? localStorage.getItem('selectedProduct') : 0;
    function setValues(e) {
        // console.log(e);
        var el = $$(e.el);
        // console.log(input);
        var input = el.find('input[name="data[BeneficiaryPhoneNumber]"]');
        var phoneNumber = localStorage.getItem('phoneNumber');
        input.val(phoneNumber);
    }

    function loadPopup(form) {
        var formData = form;
        var popup = app.popup.create({
            el: '.airtime-popup',
            on: {
                opened: function (popup) {
                    var el = $$(popup.el);
                    var btn = el.find('#proceedSummary');
                    // loadform(form);
                    Formio.createForm(document.getElementById('formio'), formData[0].form).then(function(feeForm) {
                        feeForm.on('initialized', function(){
                            console.log(el);
                            console.log(localStorage.getItem('phoneNumber'))
                            // if (localStorage.getItem('isBeneficiary')) {
                            //     el.find('input[name=data[BeneficiaryPhoneNumber]]').val(localStorage.getItem('phoneNumber'))
                            // }
                        });
                        feeForm.on('change', function() {
                            btn.removeClass('disabled');
                            localStorage.setItem('paymentForm', JSON.stringify(feeForm.submission));
                        })
                    });
                }
            }
        });
        popup.open();
        if(localStorage.getItem('isBeneficiary')){
            popup.on('opened', setValues);
        }
    }

    function loadform(form) {
        let formComponent = form[0].form;
        Formio.createForm(document.getElementById('paymentForm'), formComponent)
            .then(function(payForm) {
                payForm.on('change', function() {
                    $$('#proceedSummary').removeClass('disabled');
                    localStorage.setItem('paymentForm', JSON.stringify(payForm.submission));
                })
            });
    }

    function getPageCategories(data) {
        let airtimeData = data.filter(item => item.name === 'Airtime');
        let categories = airtimeData[0].products.map(item => {
            const container = {
                createdWhen: item.createdWhen,
                form: JSON.parse(item.form),
                guid: item.guid,
                image: item.image,
                name: item.name,
                productCategoryId: item.productCategoryId,
                productId: item.productId
            };
            return container;
        });
        // console.log(categories);
        return categories;
    }

    function loadSummary(form, popup) {
        app.preloader.show('orange');
        form.isValid = true;
        // debugger;
        axios.post(app.data.apiUrl + 'api/payments/getfees', JSON.stringify(form), {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('sessionToken')
            }
        }).then(function (response) {
            app.preloader.hide();
            var summary = app.popup.create({
                el: '.airtime-summary',
                on: {
                    opened: function (popup) {
                        // console.log(formData);
                        var el = $$(popup.el);
                        var receipient = el.find('.transactionWizardButton.receipient');
                        var amt = el.find('.transactionWizardButton.amt span');
                        var fee = el.find('.transactionWizardButton.fee span');
                        var vat = el.find('.transactionWizardButton.vat span');
                        receipient.text(form.data.BeneficiaryPhoneNumber);
                        amt.text(form.data.Amount.toFixed(2));
                        fee.text(response.data.fee);
                        vat.text(response.data.vat);
                        // loadform(form);
                    }
                }
            });
            summary.open();
        }).catch(function (err) {
            app.preloader.hide();
            var errToast = app.toast.create({
                text: 'We encountered a problem. Please try again',
                closeButton: true,
                closeButtonText: 'TRY AGAIN'
            });
            errToast.open();
        });
    }
    const getCategories = async () => {
        if (localStorage.getItem('productCategories')) return getPageCategories(JSON.parse(localStorage.getItem('productCategories')));
        app.preloader.show('orange');
        try {
            const resp = await axios.get(app.data.apiUrl + 'api/payments/productcategories', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('sessionToken') } });
            // debugger;
            app.preloader.hide();
            localStorage.setItem('productCategories', JSON.stringify(resp.data));
            return getPageCategories(resp.data);
        } catch (err) {
            app.preloader.hide();
            return err;
        }
    };
    // getCategories();
    export default {
        async data () {
            return {
                logo: logo,
                userData: localStorage.getItem('loginData') ? JSON.parse(localStorage.getItem('loginData')) : null,
                isLoggedIn: localStorage.getItem('isLoggedIn') ? localStorage.getItem('isLoggedIn') : false,
                currDate: currentDate,
                categories: await getCategories()
                // categories: await getCategories()
            }
        },
        methods: {
            selectProvider(e) {
                let prodid = parseInt($$(e.target).parent().data('name'));
                let form = this.categories.filter(cat => cat.productId == prodid);
                var imgSrc = $$(e.target).attr('src');
                $$('.provider-img').attr('src', imgSrc);
                if ($$(e.target).parent().hasClass('selectedProvider')) {
                    $$(e.target).parent().removeClass('selectedProvider');
                } else {
                    $$('.provider-images').each(function (i) {
                        if ($$(this).hasClass('selectedProvider')) {
                            $$(this).removeClass('selectedProvider');
                        }
                    })
                    $$(e.target).parent().addClass('selectedProvider');
                    loadPopup(form);
                    // $$('#continueProcess').removeClass('disabled');
                    // loadform(form);
                }
            },
            proceedPayment() {
                var popup = app.popup.create({
                    el: '.airtime-popup',
                    on: {
                        opened: function (popup) {
                            console.log('opened');
                        }
                    }
                });
                popup.open();
            },
            makePayment() {
                var popup = app.popup.get('.transfer-popup');
                let formSubmission = JSON.parse(localStorage.getItem('paymentForm'));
                // popup.close();
                loadSummary(formSubmission, popup);
            },
            performTransaction() {
                let submission = JSON.parse(localStorage.getItem('paymentForm'));
                submission.isValid = true;
                submission.redirectURL = 'file:///assets/www/index.html';
                submission.data.redirectURL = 'file:///assets/www/index.html';
                app.preloader.show('orange');
                axios.post(app.data.apiUrl + 'api/payments/processrequest', JSON.stringify(submission), {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('sessionToken')
                    }
                }).then(function (response) {
                    app.preloader.hide();
                    var redirectUrl = response.data.order.orderURL;
                    $$('#proceedSummary').addClass('disabled');
                    if (app.device.cordova) {
                        console.log(window.location.href);
                        var browserRef = window.open(redirectUrl, '_self', 'location=no');
                        browserRef.show();
                        browserRef.addEventListener('exit', function (e) {
                            console.log(e);
                            const queryString = window.location.search;
                            const urlParams = new URLSearchParams(queryString);
                            let transactionStatus = urlParams.get('transactionStatus');
                            let transactionid = urlParams.get('transactionid');
                            if (transactionStatus == 'SUCCESS') {
                                loadSuccessPopup(transactionStatus, transactionid);
                            } else if (transactionStatus == 'FAILED') {
                                loadFailurePopup(transactionStatus, transactionid);
                            } else {
                                app.views.main.router.navigate('/')
                            }
                        })
                    } else {
                        window.open(redirectUrl, '_self', 'location=yes');
                    }
                }).catch(function (err) {
                    app.preloader.hide();
                    var errToast = app.toast.create({
                        text: 'We could perform the transaction. You may have to try at another time',
                        closeButton: true,
                        closeButtonText: 'TRY AGAIN'
                    });
                    errToast.open();
                })
            }
        }
    }
</script>