<template>
    <div class="page" data-name="start">
        <div class="page-content startPage display-flex flex-direction-column">
            {{#js_if "this.clientTransactions.length > 0"}}
            <div class="justify-content-start mt-auto mb-auto">
                <h2 class="padding-horizontal">Good Day,</h2>
                <p class="appUser padding-horizontal">
                    {{userData.name}}
                </p>

                <div class="ml-auto block">
                    <div class="section-header padding-left">
                        <i class="icon f7-icons">lightbulb</i> <span>Featured</span>
                    </div>
                    <div class="swiper-container featured-swiper">
                        <!-- data-pagination='{"el": ".swiper-pagination"}' -->
                        <!-- <div class="swiper-pagination"></div> -->
                        <div class="swiper-wrapper">
                            {{#featured}}
                            <div class="swiper-slide">
                                <div class="card" data-productId={{productId}} @click="loadPayment">
                                    <div class="card-content card-content-padding text-align-center"
                                        data-productId={{productId}}>
                                        <div class="featured-cards" style="height: 90px" data-productId={{productId}}>
                                            <img src="data:image/png;base64, {{image}}" alt={{name}} class="img-fluid"
                                                data-productId={{productId}} />
                                            <span>{{name}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {{/featured}}
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="justify-content-end mt-auto block">
                <div class="section-header padding-left margin-top">
                    <i class="icon f7-icons">clock</i> <span>History</span>
                </div>
                <div class="list margin-top">
                    <!-- <ul> -->

                    <div class="timeline no-padding-right no-margin-vertical">
                        {{#clientTransactions}}
                        <div class="timeline-item">
                            <div class="timeline-item-date"><small>{{createdAt}}</small></div>
                            <div class="timeline-item-divider"></div>
                            <div class="list no-margin">
                                <ul>
                                    <li class="swipeout">
                                        <div class="swipeout-content">
                                            <div class="timeline-item-content card no-padding-bottom">
                                                <div class="card-header">{{transactionDescription}}</div>
                                                <div class="card-content card-content-padding">
                                                    <p class="amountText">Amount Paid: {{amountPaid}} {{currency}}</p>
                                                    <p class="transStatus">
                                                        Transaction Status: {{#js_if "this.status === 'APPROVED'"}}<span
                                                            class="badge color-green">{{status}}</span>{{else}}<span
                                                            class="badge color-denied">{{status}}</span>{{/js_if}}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="swipeout-actions-right">
                                            <a href="" class="open-more-actions repeat bg-color-white text-color-brown">
                                                <i class="icon f7-icons elevation-10">repeat</i>
                                            </a>
                                            <a href="#"
                                                class="open-more-actions download bg-color-white text-color-brown">
                                                <i class="icon f7-icons elevation-10">cloud_download_fill</i>
                                            </a>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                        </div>
                        {{/clientTransactions}}
                    </div>
                    <!-- <li class="swipeout">
                            <div class="item-content swipeout-content no-padding-left">
                                <div class="item-inner no-padding-right no-margin-vertical no-padding-vertical">
                                    
                                </div>
                            </div>
                            <div class="swipeout-actions-right">
                                <a href="" class="open-more-actions repeat bg-color-white text-color-brown">
                                    <i class="icon f7-icons elevation-10">repeat</i>
                                </a>
                                <a href="#" class="open-more-actions download bg-color-white text-color-brown">
                                    <i class="icon f7-icons elevation-10">cloud_download_fill</i>
                                </a>
                            </div>
                        </li> -->

                    </ul>
                </div>
            </div>
            {{else}}
            {{#js_if "this.clientTransactions == 'Error: Request failed with status code 401'"}}
            <div class="justify-content-end mb-auto">
                <div class="padding-horizontal">
                    <div class="card tipsCard mx-auto w-80">
                        <div class="card-content bg-color-red card-content-padding tipsTricks">
                            <i class="icon f7-icons">bolt_slash</i>
                            <h5>Session Terminated</h5>
                            <p>Please login <a href="#" @click="loginUser">here</a></p>
                        </div>
                    </div>
                </div>
            </div>

            {{else}}
            <div class="justify-content-end mb-auto">
                <div class="padding-horizontal">
                    <div class="justify-content-center mt-auto mb-auto margin-top">
                        <div class="card text-align-center newTransactions elevation-10 border-radius-10">
                            <img src={{logo}} alt="" class='rounded-img'>
                            <div
                                class="card-content bg-color-white text-color-black padding-vertical padding-horizontal">
                                <div class="card-header">I'll help you make your first fast and secure transaction with
                                    ARAKA</div>
                                <div class="card-content-padding">
                                    <p>
                                        ARAKA allows you to make fast and secure payments to your children's schools,
                                        your TV providers among many other use cases
                                    </p>
                                    <p>
                                        Click the [$] below and select the type of "Payment" - then ARAKA will perform
                                        it
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {{/js_if}}
            {{/js_if}}

        </div>

        <!-- payment popup -->
        <div class="popup payment-popup">
            <div class="justify-content-start margin-top">
                <a class="link popup-close padding-left padding-right" href="#">
                    <i class="icon icon-back text-color-brown"></i>
                </a>
            </div>
            <div data-pagination='{"el": ".swiper-pagination"}'
                class='swiper-container swiper-init payment-swiper padding-top'>
                <div class="swiper-pagination"></div>
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <div class="payment-1 display-flex flex-direction-column overflow-y-auto">
                            <div class="justify-content-start">
                                <div class="block no-margin-bottom text-align-center">
                                    <img src={{logo}} alt="ARAKA" class="img-fluid-header">
                                </div>
                                <div class="text-align-center transactionDate">
                                    <p class="font-weight-bold">{{currDate}}</p>
                                </div>
                                <div class="block">
                                    <h5 class="no-margin-vertical transactionWizardHeader">Payments for</h5>
                                    <img src="" alt="" class="provider-img">
                                    <p class="paymentFor no-margin-top"></p>
                                </div>
                                <div class="block no-margin-top">
                                    <div id="paymentForm"></div>
                                </div>
                            </div>
                            <div class="justify-content-end mt-auto margin-bottom-50 text-align-center">
                                <a href="" id="goToSummary"
                                    class="w-40 mx-auto button button-raised button-large button-fill elevation-12 elevation-pressed-20 elevation-transition disabled"
                                    @click="showSummary">
                                    Continue
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="payment-2 display-flex flex-direction-column">
                            <div class="justify-content-start">
                                <div class="block no-margin-bottom text-align-center">
                                    <img src={{logo}} alt="ARAKA" class="img-fluid-header">
                                </div>
                                <div class="text-align-center transactionDate">
                                    <p class="font-weight-bold">{{currDate}}</p>
                                </div>
                                <div class="row margin-top">
                                    <div class="col">
                                        <h5 class="no-margin-vertical transactionWizardHeader">Provider</h5>
                                        <img src="" alt="" class="provider-img">
                                    </div>
                                </div>
                                <div class="row margin-top">
                                    <div class="col-50">
                                        <h5 class="no-margin-vertical transactionWizardHeader">Payment for</h5>
                                        <p class="transactionWizardButton receipient"><i
                                                class="icon f7-icons">bolt_horizontal_circle_fill</i> <span></span></p>
                                    </div>
                                    <div class="col-50">
                                        <h5 class="no-margin-vertical transactionWizardHeader">Amount</h5>
                                        <p class="transactionWizardButton amt"><i
                                                class="icon f7-icons">money_dollar_circle_fill</i> <span></span></p>
                                    </div>
                                </div>
                                <div class="row margin-top">
                                    <div class="col-50">
                                        <h5 class="no-margin-vertical transactionWizardHeader">Fee</h5>
                                        <p class="transactionWizardButton fee"><i
                                                class="icon f7-icons">money_dollar_circle_fill</i> <span></span></p>
                                    </div>
                                    <div class="col-50">
                                        <h5 class="no-margin-vertical transactionWizardHeader">VAT</h5>
                                        <p class="transactionWizardButton vat"><i
                                                class="icon f7-icons">money_dollar_circle_fill</i> <span></span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="justify-content-end mt-auto margin-bottom-50 text-align-center">
                                <a href="" id="makePayment"
                                    class="w-40 mx-auto button button-raised button-large button-fill elevation-12 elevation-pressed-20 elevation-transition"
                                    @click="performTransaction">
                                    Make Payment
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- success popup -->
        <div class="popup success-popup">
            <div class="display-flex flex-direction-column h-100">
                <div class="justify-content-start margin-top">
                    <a class="link popup-close padding-left padding-right" href="#">
                        <i class="icon f7-icons text-color-brown">xmark</i>
                    </a>
                </div>
                <div class="justify-content-center mb-auto text-align-center">
                    <div class="block">
                        <img src={{logo}} alt="ARAKA">
                    </div>
                    <h3>Transaction Successful!</h3>
                    <div class="text-align-center bg-color-green text-color-white successArea mx-auto elevation-4">
                        <i class="icon f7-icons">checkmark_alt</i>
                    </div>
                </div>
            </div>
        </div>

        <!-- failure popup -->
        <div class="popup failure-popup">
            <div class="display-flex flex-direction-column h-100">
                <div class="justify-content-start margin-top">
                    <a class="link popup-close padding-left padding-right" href="#">
                        <i class="icon f7-icons text-color-brown">xmark</i>
                    </a>
                </div>
                <div class="justify-content-center text-align-center mb-auto">
                    <div class="block">
                        <img src={{logo}} alt="ARAKA">
                    </div>
                    <h3>Transaction Failed!</h3>
                    <div class="text-align-center bg-color-red text-color-white successArea mx-auto elevation-4">
                        <i class="icon f7-icons">xmark</i>
                    </div>
                </div>
            </div>
        </div>

        <!-- transaction popup -->
        <div class="popup transaction-popup">
            <iframe src="" frameborder="0"></iframe>
        </div>
    </div>
</template>
<script>
    import app from '../../js/app.js';
    import $$ from 'dom7';
    import axios from 'axios';
    import dayjs from 'dayjs';
    import logo from '../../images/welcome_araka-alt.png';
    import { Formio } from 'formiojs';


    let currentDate = dayjs().format('DD. MMMM, h:mm a');

    function loadSuccessPopup(status, id) {
        app.popup.open('.success-popup', true);
    }

    function loadFailurePopup(status, id) {
        app.popup.open('.failure-popup', true);
    }

    function loadform(form) {
        Formio.createForm(document.getElementById('paymentForm'), form)
            .then(function (payForm) {
                payForm.on('change', function () {
                    $$('#goToSummary').removeClass('disabled');
                    localStorage.setItem('paymentForm', JSON.stringify(payForm.submission));
                })
            })
    }

    function loadSummary(form, swiper) {
        app.preloader.show('orange');
        form.isValid = true;
        axios.post(app.data.apiUrl + 'api/payments/getfees', JSON.stringify(form), {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('sessionToken')
            }
        }).then(function (response) {
            app.preloader.hide();
            $$('.transactionWizardButton.amt span').text(form.data.Amount.toFixed(2));
            $$('.transactionWizardButton.fee span').text(response.data.fee);
            $$('.transactionWizardButton.vat span').text(response.data.vat);
            // swiper.slideNext();
        }).catch(function (response) {
            app.preloader.hide();
            var errToast = app.toast.create({
                text: 'We encountered a problem. Please try again',
                closeButton: true,
                closeButtonText: 'TRY AGAIN'
            });
            errToast.open();
        })
    }

    function prettifyOby(data) {
        let clientTransactions = data.map(item => {
            const container = {
                amountPaid: item.amountPaid,
                charge: item.charge,
                createdAt: dayjs(item.createdAt).format('DD. MMMM'),
                currency: item.currency,
                status: item.status,
                transactionDescription: item.transactionDescription,
                transactionDetails: item.transactionDetails,
                transactionId: item.transactionId,
                vat: item.vat
            }
            return container;
        });
        return clientTransactions;
    }

    function getFeaturedItems(obj) {
        var products = [];
        for (var i = 0; i < obj.length; i++) {
            for (var j = 0; j < obj[i].products.length; j++) {
                products.push({
                    createdWhen: obj[i].products[j].createdWhen,
                    productId: obj[i].products[j].productId,
                    productCategoryId: obj[i].products[j].productCategoryId,
                    image: obj[i].products[j].image,
                    form: obj[i].products[j].form,
                    guid: obj[i].products[j].guid,
                    name: obj[i].products[j].name
                });
            }
        }
        return products;
    };

    const getTransactions = async () => {
        app.preloader.show('orange');
        try {
            const resp = await axios.get(app.data.apiUrl + 'api/payments/transactionhistory', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('sessionToken') } });
            app.preloader.hide();
            return prettifyOby(resp.data);
        } catch (err) {
            app.preloader.hide();
            // console.log(err);
            return err;
        }
    };

    const getCategories = async () => {
        if (localStorage.getItem('productCategories')) return getFeaturedItems(JSON.parse(localStorage.getItem('productCategories')));
        app.preloader.show('orange');
        try {
            const resp = await axios.get(app.data.apiUrl + 'api/payments/productcategories', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('sessionToken') } });
            app.preloader.hide();
            localStorage.setItem('productCategories', JSON.stringify(resp.data));
            return getFeaturedItems(resp.data);
        } catch (err) {
            app.preloader.hide();
            return err;
        }
    };
    export default {
        async data() {
            return {
                userData: localStorage.getItem('loginData') ? JSON.parse(localStorage.getItem('loginData')) : null,
                isLoggedIn: localStorage.getItem('isLoggedIn') ? localStorage.getItem('isLoggedIn') : false,
                logo: logo,
                clientTransactions: await getTransactions(),
                currDate: currentDate,
                featured: await getCategories(),
                paymentFor: '',
                // categories: await localStorage.getItem('productCategories') ? JSON.parse(localStorage.getItem('productCategories')) : await getCategories()
            }
        },
        mounted() {
            // app.preloader.show(); //var app is initialized by now
            // app.on('pageInit', function (page) {
            //     console.log('Page is now initialized');
            //     app.preloader.hide();
            // });
            this.featuredSwiper = this.$f7.swiper.create('.featured-swiper', {
                speed: 400,
                spaceBetween: 10,
                slidesPerView: 3
            });
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            let transactionStatus = urlParams.get('transactionStatus');
            let transactionid = urlParams.get('transactionid');
            if (transactionStatus == 'SUCCESS') {
                loadSuccessPopup(transactionStatus, transactionid);
            } else if (transactionStatus == 'FAILED') {
                loadFailurePopup(transactionStatus, transactionid);
            } else {
                return true;
            }
        },
        methods: {
            renderDate() {
                return dayjs().format('DD MMM');
            },
            loginUser() {
                app.views.main.router.navigate('/login-screen/');
            },
            loadPayment(e) {
                var productId = $$(e.target).data('productId');
                if (productId === undefined) return false;
                let product = this.featured.filter(category => category.productId == productId);
                if (product.length < 1) {
                    var errToast = app.toast.create({
                        text: 'We encountered a problem. Please try again',
                        closeButton: true,
                        closeButtonText: 'CLOSE'
                    });
                    errToast.open();
                } else {
                    this.paymentFor = product[0].name;
                    $$('.transactionWizardButton.receipient span').text(product[0].name);
                    $$('.paymentFor').text(product[0].name);
                    $$('.provider-img').attr('src', 'data:image/png;base64,' + product[0].image);
                    loadform(JSON.parse(product[0].form));
                    app.popup.open('.payment-popup', true);
                }
            },
            showSummary() {
                let swiper = app.swiper.get('.payment-swiper');
                let submission = JSON.parse(localStorage.getItem('paymentForm'));
                loadSummary(submission, swiper);
                swiper.slideNext();
                // console.log(swiper);
                // console.log('make payment')
            },
            performTransaction() {
                let submission = JSON.parse(localStorage.getItem('paymentForm'));
                submission.isValid = true;
                submission.redirectURL = 'file:///assets/www/index.html';
                submission.data.redirectURL = 'file:///assets/www/index.html';
                app.preloader.show('orange');
                debugger;
                axios.post(app.data.apiUrl + 'api/payments/processrequest', JSON.stringify(submission), {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('sessionToken')
                    }
                }).then(function (response) {
                    app.preloader.hide();
                    var redirectUrl = response.data.order.orderURL;
                    $$('#goToSummary').addClass('disabled');
                    console.log(app.device);
                    if (app.device.cordova) {
                        console.log(window.location.href);
                        var browserRef = window.open(redirectUrl, '_self', 'location=no');
                        browserRef.show();
                        browserRef.addEventListener('exit', function (e) {
                            console.log(e);
                            const queryString = window.location.search;
                            const urlParams = new URLSearchParams(queryString);
                            let transactionStatus = urlParams.get('transactionStatus');
                            let transactionid = urlParams.get('transactionid');
                            if (transactionStatus == 'SUCCESS') {
                                loadSuccessPopup(transactionStatus, transactionid);
                            } else if (transactionStatus == 'FAILED') {
                                loadFailurePopup(transactionStatus, transactionid);
                            } else {
                                app.views.main.router.navigate('/')
                            }
                        })
                    } else {
                        window.open(redirectUrl, '_self', 'location=yes');
                    }
                    // $$('.transaction-popup iframe').attr('src', redirectUrl);
                    // app.popup.open('.transaction-popup', true);
                    // window.open(redirectUrl, '_self');
                    // window.addEventListener('unload', function(ev) {
                    //     console.log(ev);
                    // }) 
                    // ref.addEventListener('exit', function() { alert(event.type); })
                }).catch(function (err) {
                    app.preloader.hide();
                    var errToast = app.toast.create({
                        text: 'We could not perform this transaction. Please try again later.',
                        closeButton: true,
                        closeButtonText: 'TRY AGAIN'
                    });
                    errToast.open();
                })
            }
        }
    }
</script>